# Mask R-CNN with Swin Transformer Tiny Backbone on COCO
#
# This config demonstrates:
# - _base_ inheritance for dataset, optimizer, and schedule
# - $ref resolution for model components (backbone, neck, heads)
# - Override mechanism for customizing base configs

# Inherit base configurations
_base_:
  - ../components/datasets/coco_instance.yaml
  - ../components/optimizers/adamw_default.yaml
  - ../components/schedules/1x.yaml

# Model configuration using $ref for components
model:
  type: MaskRCNN

  # Data preprocessor
  data_preprocessor:
    type: DetDataPreprocessor
    mean: [123.675, 116.28, 103.53]
    std: [58.395, 57.12, 57.375]
    bgr_to_rgb: true
    pad_mask: true
    pad_size_divisor: 32

  # Backbone: Reference external config
  backbone:
    $ref: ../components/backbones/swin_tiny.yaml

  # Neck: Reference external config
  neck:
    $ref: ../components/necks/fpn_256.yaml

  # RPN Head: Inline definition (simple component)
  rpn_head:
    type: RPNHead
    in_channels: 256
    feat_channels: 256
    anchor_generator:
      type: AnchorGenerator
      scales: [8]
      ratios: [0.5, 1.0, 2.0]
      strides: [4, 8, 16, 32, 64]
    bbox_coder:
      type: DeltaXYWHBBoxCoder
      target_means: [0.0, 0.0, 0.0, 0.0]
      target_stds: [1.0, 1.0, 1.0, 1.0]
    loss_cls:
      type: CrossEntropyLoss
      use_sigmoid: true
      loss_weight: 1.0
    loss_bbox:
      type: L1Loss
      loss_weight: 1.0

  # RoI Head: Inline definition
  roi_head:
    type: StandardRoIHead
    bbox_roi_extractor:
      type: SingleRoIExtractor
      roi_layer:
        type: RoIAlign
        output_size: 7
        sampling_ratio: 0
      out_channels: 256
      featmap_strides: [4, 8, 16, 32]
    bbox_head:
      type: Shared2FCBBoxHead
      in_channels: 256
      fc_out_channels: 1024
      roi_feat_size: 7
      num_classes: 80
      bbox_coder:
        type: DeltaXYWHBBoxCoder
        target_means: [0.0, 0.0, 0.0, 0.0]
        target_stds: [0.1, 0.1, 0.2, 0.2]
      reg_class_agnostic: false
      loss_cls:
        type: CrossEntropyLoss
        use_sigmoid: false
        loss_weight: 1.0
      loss_bbox:
        type: L1Loss
        loss_weight: 1.0
    mask_roi_extractor:
      type: SingleRoIExtractor
      roi_layer:
        type: RoIAlign
        output_size: 14
        sampling_ratio: 0
      out_channels: 256
      featmap_strides: [4, 8, 16, 32]
    mask_head:
      type: FCNMaskHead
      num_convs: 4
      in_channels: 256
      conv_out_channels: 256
      num_classes: 80
      loss_mask:
        type: CrossEntropyLoss
        use_mask: true
        loss_weight: 1.0

  # Training configuration for model
  train_cfg:
    rpn:
      assigner:
        type: MaxIoUAssigner
        pos_iou_thr: 0.7
        neg_iou_thr: 0.3
        min_pos_iou: 0.3
        match_low_quality: true
        ignore_iof_thr: -1
      sampler:
        type: RandomSampler
        num: 256
        pos_fraction: 0.5
        neg_pos_ub: -1
        add_gt_as_proposals: false
      allowed_border: -1
      pos_weight: -1
      debug: false
    rpn_proposal:
      nms_pre: 2000
      max_per_img: 1000
      nms:
        type: nms
        iou_threshold: 0.7
      min_bbox_size: 0
    rcnn:
      assigner:
        type: MaxIoUAssigner
        pos_iou_thr: 0.5
        neg_iou_thr: 0.5
        min_pos_iou: 0.5
        match_low_quality: true
        ignore_iof_thr: -1
      sampler:
        type: RandomSampler
        num: 512
        pos_fraction: 0.25
        neg_pos_ub: -1
        add_gt_as_proposals: true
      mask_size: 28
      pos_weight: -1
      debug: false

  # Test configuration
  test_cfg:
    rpn:
      nms_pre: 1000
      max_per_img: 1000
      nms:
        type: nms
        iou_threshold: 0.7
      min_bbox_size: 0
    rcnn:
      score_thr: 0.05
      nms:
        type: nms
        iou_threshold: 0.5
      max_per_img: 100
      mask_thr_binary: 0.5

# Override base schedule: train for 24 epochs instead of 12 (2x schedule)
max_epochs: 24
val_interval: 2

# Training configuration (working directory, logging, etc.)
work_dir: ./work_dirs/mask_rcnn_swin_tiny_coco
log_level: INFO
load_from: null
resume_from: null

# Evaluation configuration
evaluation:
  metric: [bbox, segm]
  interval: 2
